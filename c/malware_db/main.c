/*
 * main.c - main file for malware database interface
 *
 */
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sqlite3.h>
#include <openssl/sha.h>
#include <openssl/crypto.h>


void banner(void);
int create_database(void);
int add_malware(void);
int db_request(void);
char *get_arch(void);
char *get_type(void);
char *get_format(void);
int sha256_file(char *path, char outputBuffer[65]);
void sha256(char *string, char outputBuffer[65]);
void sha256_hash_string (char hash[SHA256_DIGEST_LENGTH], char outputBuffer[65]);


int main(void) {

	// This switch statement will handle creating a new database, adding new malware,
	// requesting information from the database, or quitting.
	// the main function does NOT take any arguments, but calls subsequent functions which
	// gather information for the database.
	int n;

	banner();

	printf("Please select one of the following options:\n");
	printf("\t1. Create a new database\n");
	printf("\t2. Add more malware to a database\n");
	printf("\t3. Request information from a database\n");
	printf("\t4. Exit the program\n");
	printf("Selection: ");
	scanf("%d", &n);

	switch(n) 
	{
		case 1: // Create a new database
			puts("[+] Creating a new database...");
			create_database();
			break;

                case 2: // Add new malware
			puts("[+] Adding new malware to database...");
			add_malware();
			break;

		case 3: // Request information from db
			puts("[+] Requesting information from the database...");
		//	db_request();
			break;

		case 4: //exit
			puts("[!!] Exiting. Thanks for stopping by!");
			exit(0);

		default:
			exit(0);
	}
	return 0;
}


int create_database(void){

	sqlite3 *db;
	char *err_msg = 0;
	char db_name[50];
	char db_ext[4] = ".db";

	printf("Please enter a name for the new database: ");
	scanf("%s", db_name);

	strcat(db_name, db_ext);
	
	printf("[+] Database will be created in the current working directory...\n");
	printf("[+] Creating the new database: %s\n", db_name);

	int rc = sqlite3_open(db_name, &db);

	if (rc != SQLITE_OK) {
		fprintf(stderr, "[!!] Cannot open database: %s\n", sqlite3_errmsg(db));
		sqlite3_close(db);

		return 1;
	}
	char *sql = "DROP TABLE IF EXISTS Linux;"
		"CREATE TABLE Linux(Id INTEGER PRIMARY KEY, Name TEXT, Type TEXT, Arch TEXT, Sha256 TEXT, Sample BLOB, Report BLOB);"
		"DROP Table IF EXISTS Windows;"
		"CREATE TABLE Windows(Id INTEGER PRIMARY KEY, Name TEXT, Type TEXT, Arch TEXT, Sha256 TEXT, Sample BLOB, Report BLOB);"
		"DROP Table IF EXISTS MacOS;"
		"CREATE TABLE MacOS(Id INTEGER PRIMARY KEY, Name TEXT, Type TEXT, Arch TEXT, Sha256 TEXT, Sample BLOB, Report BLOB);"
		"DROP Table IF EXISTS Other;"
		"CREATE TABLE Other(Id INTEGER PRIMARY KEY, Name TEXT, Type TEXT, Arch TEXT, Sha256 TEXT, Sample BLOB, Report BLOB);";

	rc = sqlite3_exec(db, sql, 0, 0, &err_msg);

	if (rc != SQLITE_OK){
		fprintf(stderr, "[!!] SQL error: %s\n", err_msg);

		sqlite3_free(err_msg);
		sqlite3_close(db);

		return 1;
	}

	sqlite3_close(db);
	printf("[+] Database successfully created!\n");

	return 0;
}


int add_malware(void) {

	// Function for adding malware and other data to the database
	// Will ask for:
	// 		1. Malware OS (Linux, Windows, Mac, Other)
	// 		2. Type of malware (virus, loader, rootkit, etc)
	// 		3. Sample File (will Sha256 hash this)
	// 		4. Notes on the sample (report file)
	//
	// Additional functions:
	// 		1. Sha256 Hashing (returns the hash of the malware sample)
	// 		2. Function to call the correct SQL INSERT statments based on OS of malware (returns the sql statements)
	char *sample_name;
	char *sample_arch;
	char sample_sha256[65];
	char *sample_type;
	char *sample_format;
	char sample_path[50];
	char notes_path[50];
	

        // Get the path to the malware sample
	printf("Path to malware sample: ");
	scanf("%s", sample_path);

	// Get the malware name
	printf("What is the name for this malware sample? ");
	scanf("%s", sample_name);

	// Get Architecture of malware
	sample_arch = get_arch();

	// Get type of malware (virus, rootkit, etc)
	sample_type = get_type();

	// Get file format (ELF, PE, MachOS, docx)
	sample_format = get_format();

	// Get path to report file
	printf("Notes or report on this malware (path): ");
	scanf("%s", notes_path);

        // Get the hash for the sample
	sha256_file(sample_path, sample_sha256);
	printf("Malware SHA256 Hash: %s\n", sample_sha256);


	return 0;
}


char *get_format(void){
	int n;
	char *format;
	
	printf("Please select the malware format:\n");
	printf("\t1. PE\n");
	printf("\t2. ELF\n");
	printf("\t3. MachOS\n");
	printf("\t4. Script\n");
	printf("\t5. Document\n");
	printf("\t6. Other\n");
	printf("Selection: ");
	scanf("%d", &n);

	switch(n)
	{
		case 1: // PE 
			format = "PE";
		case 2: // ELF
			format = "ELF";
		case 3: // MACHOS
			format = "MachOS";
		case 4: // SCRIPT
			format = "Script";
		case 5: //  Document/PDF/etc
			format = "Document";
		case 6: // Other
			format = "Other";
		default:
			format = "PE";
	}
	return format;
}


char *get_type(void){
	int n;
	char *type;

	printf("Please select the malware type:\n");
	printf("\t1. Virus\n");
	printf("\t2. Trojan\n");
	printf("\t3. Worm\n");
	printf("\t4. Rootkit\n");
	printf("\t5. Ransomeware\n");
	printf("\t6. Keylogger\n");
	printf("\t7. Other\n");
	printf("Selection: ");
	scanf("%d", &n);

	switch(n)
	{
		case 1: // virus
			type = "Virus";
		case 2: //Trojan
			type = "Trojan";
		case 3: // Worm
			type = "Worm";
		case 4: // Rootkit
			type = "Rootkit";
		case 5: // Ransomware
			type = "Ransomware";
		case 6: // Keylogger
			type = "Keylogger";
		case 7: // Carrier File
			type = "Carrier";
		case 8: // Other
			type = "Other";
		default:
			type = "Trojan";
	}
	return type;
}


char *get_arch(void){
	int n;
	char *arch;

	printf("Please select the malware's architecture (Default: x86:\n");
	printf("\t1. x86 (32-bit)\n");
	printf("\t2. x86_64 (64-bit)\n");
	printf("\t3. ARM (both 32 and 64)\n");
	printf("\t4. Other (Unknown or other)\n");
	printf("Selection: ");
	scanf("%d", &n);

	switch(n)
	{
		case 1: // x86 Arch
			arch = "x86";
		case 2: // x86_64
			arch = "x86_64";
		case 3: // ARM
			arch = "ARM";
		case 4: // Other
			arch = "Other";
		default:
			arch = "x86";
	}

	return arch;
}

void sha256_hash_string (char hash[SHA256_DIGEST_LENGTH], char outputBuffer[65])
{
    int i = 0;

    for(i = 0; i < SHA256_DIGEST_LENGTH; i++)
    {
        sprintf(outputBuffer + (i * 2), "%02x", (unsigned char)hash[i]);
    }

    outputBuffer[64] = 0;
}

void sha256(char *string, char outputBuffer[65])
{
    unsigned char  hash[SHA256_DIGEST_LENGTH];
    int len;
    SHA256_CTX sha256;
    SHA256_Init(&sha256);

    len=strlen(string);
    SHA256_Update(&sha256, string,len);
    SHA256_Final(hash, &sha256);
    int i = 0;
    for(i = 0; i < SHA256_DIGEST_LENGTH; i++)
    {
        sprintf(outputBuffer + (i * 2), "%02x", (unsigned char)hash[i]);
    }
    outputBuffer[64] = 0;
}

int sha256_file(char *path, char outputBuffer[65])
{
    FILE *file = fopen(path, "rb");
    if(!file) return -534;

    unsigned char hash[SHA256_DIGEST_LENGTH];
    SHA256_CTX sha256;
    SHA256_Init(&sha256);
    const int bufSize = 32768;
    unsigned char *buffer = malloc(bufSize);
    int bytesRead = 0;
    if(!buffer) return -1;
    while((bytesRead = fread(buffer, 1, bufSize, file)))
    {
        SHA256_Update(&sha256, buffer, bytesRead);
    }
    SHA256_Final(hash, &sha256);

    sha256_hash_string(hash, outputBuffer);
    fclose(file);
    free(buffer);
    return 0;
}


void banner(void) {

        puts("	███╗   ███╗ █████╗ ██╗     ██╗    ██╗ █████╗ ██████╗ ███████╗    ██╗      ██████╗  ██████╗██╗  ██╗███████╗██████╗ ");
        puts("	████╗ ████║██╔══██╗██║     ██║    ██║██╔══██╗██╔══██╗██╔════╝    ██║     ██╔═══██╗██╔════╝██║ ██╔╝██╔════╝██╔══██╗");
        puts("	██╔████╔██║███████║██║     ██║ █╗ ██║███████║██████╔╝█████╗      ██║     ██║   ██║██║     █████╔╝ █████╗  ██████╔╝");
        puts("	██║╚██╔╝██║██╔══██║██║     ██║███╗██║██╔══██║██╔══██╗██╔══╝      ██║     ██║   ██║██║     ██╔═██╗ ██╔══╝  ██╔══██╗");
        puts("	██║ ╚═╝ ██║██║  ██║███████╗╚███╔███╔╝██║  ██║██║  ██║███████╗    ███████╗╚██████╔╝╚██████╗██║  ██╗███████╗██║  ██║");
        puts("	╚═╝     ╚═╝╚═╝  ╚═╝╚══════╝ ╚══╝╚══╝ ╚═╝  ╚═╝╚═╝  ╚═╝╚══════╝    ╚══════╝ ╚═════╝  ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝");
	puts("                                                                                                       by @linkavych\n");
	puts("An informational database for analyzed malware -- a project.\n");
}	
